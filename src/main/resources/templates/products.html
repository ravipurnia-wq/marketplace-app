<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products - TechMarket Pro</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>">
</head>
<body>
    <!-- Walmart-style Header -->
    <header class="walmart-header">
        <!-- Top Header -->
        <div class="header-top">
            <div class="container">
                <div class="header-links">
                    <a href="/about">About</a>
                    <a href="/contact">Contact</a>
                    <div sec:authorize="hasRole('ADMIN')">
                        <a href="/admin">Admin Panel</a>
                    </div>
                </div>
                <div class="header-links">
                    <span>Save money. Live better.</span>
                </div>
            </div>
        </div>
        
        <!-- Main Header -->
        <div class="header-main">
            <div class="container">
                <div class="header-content">
                    <a href="/" class="logo">TechMarket Pro</a>
                    
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search everything at TechMarket Pro online and in store" id="searchInput">
                        <button class="search-btn" onclick="performSearch()">Search</button>
                    </div>
                    
                    <div class="header-actions">
                        <div sec:authorize="!isAuthenticated()">
                            <a href="/login" class="header-action">
                                <span class="action-icon">üë§</span>
                                <span>Sign In</span>
                            </a>
                            <a href="/register" class="header-action">
                                <span class="action-icon">üìù</span>
                                <span>Register</span>
                            </a>
                        </div>
                        <div sec:authorize="isAuthenticated()">
                            <a href="/profile" class="header-action">
                                <span class="action-icon">üë§</span>
                                <span>Account</span>
                            </a>
                            <a href="/orders" class="header-action">
                                <span class="action-icon">üì¶</span>
                                <span>Orders</span>
                            </a>
                            <a href="/cart" class="header-action">
                                <span class="action-icon">üõí</span>
                                <span>Cart</span>
                            </a>
                            <a href="/logout" class="header-action">
                                <span class="action-icon">üö™</span>
                                <span>Sign Out</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Menu -->
    <nav class="nav-menu">
        <div class="container">
            <div class="nav-content">
                <a href="/" class="nav-item">Home</a>
                <a href="/products" class="nav-item active">All Products</a>
                <a href="/products?category=electronics" class="nav-item">Electronics</a>
                <a href="/products?category=gadgets" class="nav-item">Gadgets</a>
                <a href="/products?category=accessories" class="nav-item">Accessories</a>
            </div>
        </div>
    </nav>
    
    <main class="main-content">
        <div class="container">
            <!-- Page Title -->
            <div style="margin-bottom: 24px;">
                <h1 style="font-size: 28px; font-weight: 600; margin-bottom: 8px;">All Products</h1>
                <p style="color: #46474a;">Browse our complete selection of electronics and technology</p>
            </div>
            
            <!-- Filters -->
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 24px; border: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <input type="text" id="productSearch" placeholder="Search products..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #b8bcc0; border-radius: 4px; font-size: 14px;">
                    </div>
                    <select id="sortBy" style="padding: 8px 12px; border: 1px solid #b8bcc0; border-radius: 4px; font-size: 14px;">
                        <option value="">Sort by</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name A-Z</option>
                    </select>
                    <select id="priceFilter" style="padding: 8px 12px; border: 1px solid #b8bcc0; border-radius: 4px; font-size: 14px;">
                        <option value="">All Prices</option>
                        <option value="0-50">Under $50</option>
                        <option value="50-100">$50 - $100</option>
                        <option value="100-200">$100 - $200</option>
                        <option value="200+">Over $200</option>
                    </select>
                    <button onclick="applyFilters()" class="btn btn-primary btn-small">Apply</button>
                    <button onclick="clearFilters()" class="btn btn-secondary btn-small">Clear</button>
                </div>
            </div>
            
            <!-- Products Count -->
            <div style="margin-bottom: 16px;">
                <p id="productCount" style="color: #46474a; font-size: 14px;">Loading products...</p>
            </div>
            
            <!-- Product Grid -->
            <div class="product-grid" id="productGrid">
                <!-- Products will be loaded here by JavaScript -->
                <div th:each="product : ${products}" class="product-card">
                    <div class="product-image-container">
                        <div class="product-badge">Best Seller</div>
                        <img th:src="${product.imageUrl}" th:alt="${product.name}" 
                             onerror="this.src='https://via.placeholder.com/240x200/f0f0f0/666?text=TechMarket+Pro'">
                    </div>
                    <div class="product-content">
                        <h4 class="product-title" th:text="${product.name}">Product Name</h4>
                        
                        <div class="product-rating">
                            <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                            <span class="rating-count">(234)</span>
                        </div>
                        
                        <div class="product-price">
                            <span th:text="'$' + ${#numbers.formatDecimal(product.price, 1, 2)}">$0.00</span>
                            <span class="price-strike" th:if="${product.price < 100}">$199.99</span>
                        </div>
                        
                        <div class="product-actions">
                            <div sec:authorize="isAuthenticated()">
                                <button onclick="addToCart(this)" 
                                        th:data-product-id="${product.id}"
                                        th:data-product-name="${product.name}"
                                        class="btn btn-primary btn-icon">
                                    <span>üõí</span>
                                    <span>Add to cart</span>
                                </button>
                                <button onclick="buyNowWithAPI(this)" 
                                        th:data-product-id="${product.id}"
                                        class="btn btn-yellow btn-icon">
                                    <span>üí≥</span>
                                    <span>Buy now</span>
                                </button>
                            </div>
                            <div sec:authorize="!isAuthenticated()">
                                <a href="/login" class="btn btn-primary w-full">Sign in to purchase</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Message -->
            <div id="loadingMessage" style="text-align: center; padding: 40px; display: none;">
                <p>Loading more products...</p>
            </div>
            
            <!-- No Results Message -->
            <div id="noResults" style="text-align: center; padding: 40px; display: none;">
                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                <h3>No products found</h3>
                <p style="color: #46474a;">Try adjusting your search or filters</p>
                <button onclick="clearFilters()" class="btn btn-primary" style="margin-top: 16px;">Clear Filters</button>
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Shop & Browse</h3>
                    <ul class="footer-links">
                        <li><a href="/products">All Products</a></li>
                        <li><a href="/products?category=electronics">Electronics</a></li>
                        <li><a href="/products?category=gadgets">Gadgets</a></li>
                        <li><a href="/products?category=accessories">Accessories</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Account</h3>
                    <ul class="footer-links">
                        <li><a href="/login">Sign In</a></li>
                        <li><a href="/register">Create Account</a></li>
                        <li><a href="/orders" sec:authorize="isAuthenticated()">Purchase History</a></li>
                        <li><a href="/profile" sec:authorize="isAuthenticated()">Account Settings</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Customer Service</h3>
                    <ul class="footer-links">
                        <li><a href="/contact">Contact Us</a></li>
                        <li><a href="/about">About TechMarket Pro</a></li>
                        <li><a href="#">Return Policy</a></li>
                        <li><a href="#">Help Center</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Get to Know Us</h3>
                    <ul class="footer-links">
                        <li><a href="/about">About TechMarket Pro</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">News & Updates</a></li>
                        <li><a href="/api/products">Developer API</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TechMarket Pro. All rights reserved. | Save money. Live better.</p>
            </div>
        </div>
    </footer>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        
        // Search functionality
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                document.getElementById('productSearch').value = searchTerm;
                applyFilters();
            }
        }
        
        // Enter key search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
            
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                productSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        applyFilters();
                    }
                });
            }
            
            loadProducts();
        });
        
        // Load products from API
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                allProducts = await response.json();
                filteredProducts = [...allProducts];
                displayProducts();
                updateProductCount();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productCount').textContent = 'Error loading products';
            }
        }
        
        // Display products
        function displayProducts() {
            const grid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-image-container">
                        <div class="product-badge">Best Seller</div>
                        <img src="${product.imageUrl}" alt="${product.name}" 
                             onerror="this.src='https://via.placeholder.com/240x200/f0f0f0/666?text=TechMarket+Pro'">
                    </div>
                    <div class="product-content">
                        <h4 class="product-title">${product.name}</h4>
                        
                        <div class="product-rating">
                            <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                            <span class="rating-count">(234)</span>
                        </div>
                        
                        <div class="product-price">
                            <span>$${product.price.toFixed(2)}</span>
                            ${product.price < 100 ? '<span class="price-strike">$199.99</span>' : ''}
                        </div>
                        
                        <div class="product-actions">
                            <button onclick="addToCart(this)" 
                                    data-product-id="${product.id}"
                                    data-product-name="${product.name}"
                                    class="btn btn-primary btn-icon">
                                <span>üõí</span>
                                <span>Add to cart</span>
                            </button>
                            <button onclick="buyNowWithAPI(this)" 
                                    data-product-id="${product.id}"
                                    class="btn btn-yellow btn-icon">
                                <span>üí≥</span>
                                <span>Buy now</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            const priceFilter = document.getElementById('priceFilter').value;
            
            // Filter by search term
            filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            
            // Filter by price
            if (priceFilter) {
                const [min, max] = priceFilter === '200+' ? [200, Infinity] : priceFilter.split('-').map(Number);
                filteredProducts = filteredProducts.filter(product => 
                    product.price >= min && (max === undefined || product.price <= max)
                );
            }
            
            // Sort products
            if (sortBy) {
                switch (sortBy) {
                    case 'price-low':
                        filteredProducts.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-high':
                        filteredProducts.sort((a, b) => b.price - a.price);
                        break;
                    case 'name':
                        filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                }
            }
            
            displayProducts();
            updateProductCount();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('productSearch').value = '';
            document.getElementById('sortBy').value = '';
            document.getElementById('priceFilter').value = '';
            filteredProducts = [...allProducts];
            displayProducts();
            updateProductCount();
        }
        
        // Update product count
        function updateProductCount() {
            const count = filteredProducts.length;
            const total = allProducts.length;
            document.getElementById('productCount').textContent = 
                `Showing ${count} of ${total} products`;
        }
        
        // Add to cart function
        async function addToCart(button) {
            const productId = button.getAttribute('data-product-id');
            const productName = button.getAttribute('data-product-name');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<span>‚è≥</span><span>Adding...</span>';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${productId}&quantity=1`
                });
                
                if (response.ok) {
                    button.innerHTML = '<span>‚úÖ</span><span>Added!</span>';
                    button.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                    
                    setTimeout(() => {
                        alert(`${productName} added to cart successfully!`);
                        button.innerHTML = originalText;
                        button.style.background = '';
                        button.disabled = false;
                    }, 1000);
                } else {
                    throw new Error('Failed to add to cart');
                }
            } catch (error) {
                console.error('Error:', error);
                button.innerHTML = '<span>‚ùå</span><span>Error</span>';
                alert('Failed to add item to cart. Please try again.');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }
        
        // Buy now function
        async function buyNowWithAPI(button) {
            const productId = button.getAttribute('data-product-id');
            const originalHTML = button.innerHTML;
            
            button.innerHTML = '<span>‚è≥</span><span>Processing...</span>';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/payments/paypal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: productId
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    button.innerHTML = '<span>‚úÖ</span><span>Redirecting...</span>';
                    
                    const confirmMessage = `üõí PayPal Checkout - TechMarket Pro\n\n` +
                        `Product: ${result.productName}\n` +
                        `Price: $${result.productPrice}\n` +
                        `Description: ${result.productDescription}\n\n` +
                        `Proceed to secure PayPal checkout?`;
                    
                    if (confirm(confirmMessage)) {
                        window.location.href = result.paypalUrl;
                    } else {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }
                } else {
                    button.innerHTML = '<span>‚ùå</span><span>Failed</span>';
                    alert('Payment failed: ' + result.message);
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                button.innerHTML = '<span>‚ùå</span><span>Error</span>';
                alert('An error occurred while processing the payment.');
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>